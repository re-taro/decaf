\chapter{実験}

\section{概要}

\ref{sec:decaf-check}で decaf の型検査手法について述べた．
述べられている通り，tsc と比べて decaf はより厳格な型システムを実現するために tsc よりも多くの経路を型検査する．
そのため，decaf は tsc よりも型検査に時間がかかると予想される．

本章では，decaf の型検査の性能を評価する実験をする．
具体的には，decaf のテストスイートとして用意している 350 件の構文\footnote{\url{https://github.com/re-taro/decaf/tree/main/checker/specification} の specification.md と staging.md}を使用して作成したソースコードを，
decaf と tsc で型検査をし，その結果を比較する．

\section{実験内容}

decaf のテストスイートをソースコードに落とした\texttt{simple.tsx}と，それの 10 回，20 回，40 回結合した\texttt{middle.tsx}，\texttt{complex.tsx}，\texttt{very\_complex.tsx}の計 4 つのファイルを用意した．
それぞれに対して decaf と tsc で型検査をし，その結果を比較した．
ベンチマークツールには\texttt{mitata}\footnote{\url{https://github.com/evanwashere/mitata}}を使用した．

\subsection{simple.tsx}

\ref{fig:simple}に\texttt{simple.tsx}を decaf と tsc で型検査した結果を示す．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{figures/fig_exp_1_simple_tsx.png}
    \caption{\texttt{simple.tsx} を decaf と tsc で型検査した結果}
    \label{fig:simple}
\end{figure}

ベンチマーク結果を見ると， decaf は tsc の 14.01 倍の速度で型検査をしていることがわかる．

\subsection{middle.tsx}

\ref{fig:middle}に\texttt{middle.tsx}を decaf と tsc で型検査した結果を示す．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{figures/fig_exp_1_middle_tsx.png}
    \caption{\texttt{middle.tsx} を decaf と tsc で型検査した結果}
    \label{fig:middle}
\end{figure}

ベンチマーク結果を見ると，decaf は tsc の 1.99 倍の速度で型検査をしていることがわかる．

\subsection{complex.tsx}

\ref{fig:complex}に\texttt{complex.tsx}を decaf と tsc で型検査した結果を示す．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{figures/fig_exp_1_complex_tsx.png}
    \caption{\texttt{complex.tsx} を decaf と tsc で型検査した結果}
    \label{fig:complex}
\end{figure}

ベンチマーク結果を見ると， tsc は decaf の 1.31 倍の速度で型検査をしていることがわかる．

\subsection{very\_complex.tsx}

\ref{fig:very_complex}に\texttt{very\_complex.tsx}を decaf と tsc で型検査した結果を示す．

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{figures/fig_exp_1_very_complex_tsx.png}
    \caption{\texttt{very\_complex.tsx} を decaf と tsc で型検査した結果}
    \label{fig:very_complex}
\end{figure}

ベンチマーク結果を見ると， tsc は decaf の 3.57 倍の速度で型検査をしていることがわかる．

\section{考察}

各ベンチマークにおいて，常に decaf が tsc よりも速い結果とはならなかった．
そこで，型検査機ごとのベンチマークケースごとの速度を棒グラフにしたものが以下である．

\begin{figure}[H]
    \centering
    \begin{minipage}[b]{0.49\columnwidth}
        \includegraphics[width=\columnwidth]{figures/fig_exp_1_tsc_barplot.png}
        \caption{tsc の型検査速度}
        \label{fig:barplot_tsc}
    \end{minipage}
    \begin{minipage}[b]{0.49\columnwidth}
        \includegraphics[width=\columnwidth]{figures/fig_exp_1_decaf_barplot.png}
        \caption{decaf の型検査速度}
        \label{fig:barplot_decaf}
    \end{minipage}
\end{figure}

\ref{fig:barplot_tsc}を見ると，ベンチマークケースごとの速度の平均が，272.67ms 〜 451.67ms の範囲にある．
対して，\ref{fig:barplot_decaf}を見ると，ベンチマークケースごとの速度の平均が， 18.66ms 〜 1,590.00ms の範囲にある．

これは，decaf が tsc と比べてより多くの情報をプログラムから抽出し，より厳格な型システムを表現しているからだと考える．
\ref{sec:decaf-check}で述べたように，decaf は分岐を非決定論的に扱い，すべての分岐を評価し型を拡大しているのに対して，
tsc は枝刈りをしている\footnote{TODO: ファクトチェック}ため，decaf の型検査は tsc よりも多くの経路を型検査する必要がある．

結果として，プログラムのサイズが大きくなると decaf の型検査速度が遅くなることがわかった．

\section{decaf の改善点}
